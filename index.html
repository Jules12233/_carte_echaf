<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Carte interactive</title>

<!-- ‚úÖ CORRECT: vraies balises Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { margin:0; font-family: Arial, sans-serif; }

/* ================= SIDEBAR ================= */
#sidebar {
  position: absolute;
  left: 0;
  top: 0;
  width: 260px;
  height: 100vh;
  background: white;
  z-index: 1000;
  overflow-y: auto;
  padding: 15px;
  box-shadow: 2px 0 5px rgba(0,0,0,0.2);
  transition: transform 0.3s ease;
}
#sidebar.closed { transform: translateX(-100%); }
#sidebar h3 { margin-top: 0; }
#sidebar ul { list-style: none; padding: 0; }
#sidebar li {
  padding: 8px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
}
#sidebar li:hover { background-color: #f0f0f0; }
.close-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  cursor: pointer;
  font-weight: bold;
}

/* ================= BOUTONS ================= */
#menuButton {
  position: absolute;
  top: 15px;
  left: 15px;
  z-index: 1100;
  background: white;
  padding: 8px 12px;
  cursor: pointer;
  border-radius: 4px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}
.btn-all {
  background: #007bff;
  color: white;
  padding: 8px;
  text-align: center;
  margin-bottom: 10px;
  cursor: pointer;
  border-radius: 5px;
}
.btn-all:hover { background: #0056b3; }

/* ================= MAP ================= */
#map { height: 100vh; width: 100vw; }
.leaflet-popup-content img { width: 300px; border-radius: 8px; }

/* üîÅ D√©placer boutons zoom √† droite */
.leaflet-top.leaflet-left {
  left: auto !important;
  right: 10px;
}

/* ================= SERVICE SELECT ================= */
#serviceSelect {
  position: absolute;
  top: 15px;
  right: 15px;
  z-index: 1500;
  background: white;
  padding: 10px;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
#serviceSelect button { margin-left: 4px; }
</style>
</head>

<body>

<!-- S√©lecteur de service -->
<div id="serviceSelect">
  Vous √™tes :
  <button onclick="setService('MONT')">MONT</button>
  <button onclick="setService('ELEC')">ELEC</button>
  <button onclick="setService('Autre')">Autre</button>
</div>

<!-- Sidebar zones -->
<div id="menuButton" onclick="toggleSidebar()">‚ò∞ Zones</div>
<div id="sidebar">
  <span class="close-btn" onclick="toggleSidebar()">‚úï</span>
  <h3>Zones</h3>
  <div class="btn-all" onclick="afficherTous()">Afficher tous</div>
  <ul id="zoneList"></ul>
</div>

<div id="map"></div>

<script>
// =============================
// CONFIG API
// =============================
const API_URL = "https://script.google.com/macros/s/AKfycbyOicdw0c_8pi0psc4GU4oXp3-7e7qJU2vu_sFG27XE2AWebLrlENyzzRKu_E4iM_Hl/exec";

let currentService = null;
function setService(s) {
  currentService = s;
  alert("Vous √™tes : " + s);
}

// =============================
// UTIL: normaliser les titres (cl√© fiable)
// =============================
function normalize(str) {
  return String(str)
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "") // accents
    .replace(/\s+/g, " ")            // espaces multiples -> 1
    .trim()
    .toLowerCase();
}

// =============================
// INITIALISATION CARTE
// =============================
var map = L.map('map', { crs: L.CRS.Simple, minZoom: -2 });
var bounds = [[0,0], [4967,7021]];
L.imageOverlay('carte.jpeg', bounds).addTo(map);
map.fitBounds(bounds);

// =============================
// DONN√âES
// =============================
var points = [
  { x:1468, y:2508, titre:"Tour de livraison Est HMA", image:"photo01.jpg", zone: "HMA 567" },
  { x:1264, y:1885, titre:"Tour de livraison HBA", image:"photo02.jpg", zone: "HBA" },
  { x:2072, y:2612, titre:"Cath√©drale UP4", image:"photo03.jpg", zone: "HMA 1234"  },
  { x:2197, y:2612, titre:"Cath√©drale UP3", image:"photo05.jpg", zone: "HMA 1234"  },
  { x:2573, y:2888, titre:"Rack eau", image:"photo06.jpg", zone: "HYA"  },
  { x:2453, y:3031, titre:"Acc√®s TF1", image:"photo07.jpg", zone: "HQA 1234"  },
  { x:2324, y:3031, titre:"Acc√®s TF2", image:"photo08.jpg", zone: "HQA 1234"  },
  { x:2196, y:3031, titre:"Acc√®s TF3", image:"photo09.jpg", zone: "HQA 1234"  },
  { x:2068, y:3031, titre:"Acc√®s TF4", image:"photo10.jpg", zone: "HQA 1234"  },
  { x:2044, y:3094, titre:"Ballon Ouest HVB", image:"photo11.jpg", zone: "HVB"  },
  { x:1882, y:2937, titre:"Rack liaison BL partie HLA", image:"photo12.jpg", zone: "HVB"  },
  { x:2056, y:2892, titre:"√âchafaudage volant", image:"photo13.jpg", zone: "HMA 1234"  },
  { x:2202, y:3100, titre:"TF3", image:"photo14.jpg", zone: "HQA 1234"  },
  { x:2102, y:3130, titre:"TF4", image:"photo15.jpg", zone: "HQA 1234"  },
  { x:2212, y:3185, titre:"Chemin√©e NO", image:"photo16.jpg", zone: "HQA 1234"  },
  { x:1956, y:3098, titre:"Chemin de c√¢bles HVB", image:"photo17.jpg", zone: "HVB"  },
  { x:1883, y:3130, titre:"Ballon Est HVB", image:"photo18.jpg", zone: "HVB"  },
  { x:1883, y:3416, titre:"Rack liaison BL partie HFD", image:"photo19.jpg", zone: "HFD"  },
  { x:1936, y:3533, titre:"Ext HFD", image:"photo20.jpg", zone: "HFD"  },
  { x:1946, y:3584, titre:"Int√©rieur HFD", image:"photo21.jpg", zone: "HFD"  },
  { x:1336, y:3488, titre:"Effluents huileux", image:"photo22.jpg", zone: "HXA"  },
  { x:1458, y:3842, titre:"Cuves huile", image:"photo23.jpg", zone: "HFA"  },
  { x:1885, y:2860, titre:"Tirage c√¢ble ext HLA", image:"photo24.jpg", zone: "HLA"  },
  { x:1945, y:3707, titre:"Rack incendie", image:"photo25.jpg", zone: "HFD"  },
  { x:2525, y:2483, titre:"Tour de livraison Ouest HMA", image:"photo26.jpg", zone: "HMA 1234"  },
  { x:2070, y:2776, titre:"Fond UP4", image:"photo27.jpg", zone: "HMA 1234"  },
  { x:2195, y:2776, titre:"Fond UP3", image:"photo28.jpg", zone: "HMA 1234"  },
  { x:2325, y:2776, titre:"Fond UP2", image:"photo29.jpg", zone: "HMA 1234"  },
  { x:2447, y:2776, titre:"Fond UP1", image:"photo30.jpg", zone: "HMA 1234" }
];

// =============================
// MARQUEURS
// =============================

// Ic√¥nes Leaflet color√©es (r√©f√©rentiel public)
function coloredIcon(color) {
  return new L.Icon({
    iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
    shadowUrl: "https://unpkg.com/leaflet/dist/images/marker-shadow.png",
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
  });
}
const icons = {
  utile: coloredIcon("green"),
  d√©montable: coloredIcon("red"),
  attente: coloredIcon("grey")
};

var markers = [];
var zonesCenters = {};

points.forEach(function(p){
  const normID = normalize(p.titre);

  var marker = L.marker([p.x, p.y], { icon: icons.attente })
    .bindPopup(`
      <b>${p.titre}</b><br>
      <img src="${p.image}" alt="${p.titre}"><br><br>
      <button onclick="sendVote('${normID}','utile')">Utile</button>
      <button onclick="sendVote('${normID}','d√©montable')">D√©montable</button>
      <button onclick="sendVote('${normID}','attente')">En attente</button>
    `);

  marker.id = normID;       // ‚úÖ cl√© fiable
  marker.zone = p.zone;

  markers.push(marker);
  marker.addTo(map);

  if (!zonesCenters[p.zone]) zonesCenters[p.zone] = { sumX:0, sumY:0, count:0 };
  zonesCenters[p.zone].sumX += p.x;
  zonesCenters[p.zone].sumY += p.y;
  zonesCenters[p.zone].count += 1;
});

// =============================
// LISTE ZONES
// =============================
var zones = [...new Set(points.map(p => p.zone))];
var zoneList = document.getElementById("zoneList");

zones.forEach(function(zone){
  var li = document.createElement("li");
  li.textContent = zone;
  li.onclick = function(){ filtrer(zone); };
  zoneList.appendChild(li);
});

// =============================
// FILTRAGE
// =============================
function filtrer(zone){
  markers.forEach(function(m){
    if (m.zone === zone) map.addLayer(m);
    else map.removeLayer(m);
  });

  var z = zonesCenters[zone];
  var centerX = z.sumX / z.count;
  var centerY = z.sumY / z.count;

  map.setView([centerX, centerY], map.getZoom());
}
function afficherTous(){
  markers.forEach(function(m){ map.addLayer(m); });
  map.fitBounds(bounds);
}

// =============================
// SIDEBAR
// =============================
function toggleSidebar(){
  document.getElementById("sidebar").classList.toggle("closed");
}

// =============================
// VOTE + M√†J imm√©diate
// =============================
function sendVote(id, etat){
  if (!currentService){
    alert("Choisissez d'abord votre service (MONT / ELEC / Autre).");
    return;
  }

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ id, service: currentService, etat })
  })
  .then(r => r.text())
  .then(() => refreshStates())
  .catch(err => console.error("Erreur POST:", err));
}

// =============================
// CHARGER LES √âTATS (no-cache + normalisation)
// =============================

function refreshStates(){
  // bust cache c√¥t√© navigateur + c√¥t√© proxy Google
  const url = API_URL + (API_URL.includes('?') ? '&' : '?') + 'v=' + Date.now();

  fetch(url, { cache: "no-store" })
    .then(r => {
      if (!r.ok) throw new Error('GET ' + r.status);
      return r.json();
    })
    .then(etats => {
      // (debug) voir ce que renvoie l‚ÄôAPI
      console.log('ETATS depuis API:', etats);

      // normaliser les cl√©s re√ßues (au cas o√π le Sheet a des ID non normalis√©s)
      const normalizedData = {};
      Object.keys(etats).forEach(k => normalizedData[normalize(k)] = etats[k]);

      markers.forEach(m => {
        const etat = normalizedData[m.id] || "attente";
        m.closePopup();                 // √©vite les incoh√©rences d‚Äôic√¥nes
        m.setIcon(icons[etat]);
      });
    })
    .catch(err => console.error("Erreur GET:", err));
}


// Premier chargement des √©tats
refreshStates();

</script>
</body>
</html>

